# 角色管理与隔离系统

## 核心原则（奥卡姆剃刀）

**最简设计**：一个标识符 + 一个状态空间 + 一套切换规则

## 基本角色定义

### 1. 律师角色

- **角色 ID**: `lawyer`
- **特性**: 必须绑定委托人身份
- **职责**: 忠实维护委托人利益

### 2. 法官角色

- **角色 ID**: `judge`
- **特性**: 单一实例
- **职责**: 中立裁判，主持庭审

## 角色标识符系统

### 唯一标识符生成

```
角色标识符 = role_type + "_" + client_id
```

例如：

- 原告律师：`lawyer_plaintiff`
- 被告一律师：`lawyer_defendant1`
- 被告二律师：`lawyer_defendant2`
- 法官：`judge_court`

## 角色实例化

```
原告律师: 律师角色 + 原告委托人
被告律师: 律师角色 + 被告委托人
法官: 法官角色（无需额外绑定）
```

## 状态空间隔离

### 独立状态空间设计

每个角色维护独立状态空间：

1. **身份信息**：角色类型、委托人身份、职责
2. **记忆内容**：已读材料、立场观点、历史发言
3. **行为模式**：辩护策略、质证方法、论证风格

### 状态持久化机制

1. **状态保存**：发言后自动保存状态
2. **状态恢复**：切换时加载对应状态

## 角色切换规则

### 基本规则

1. **激活命令**: `promptx_action("<角色ID>")`
2. **律师身份绑定**: 必须明确当前代理的委托人
3. **单一身份**: 律师只能代表一方当事人发言
4. **身份隔离**: 角色间记忆和立场严格隔离

### 角色激活示例

| 发言人   | 激活命令                   | 身份设定       |
| -------- | -------------------------- | -------------- |
| 原告律师 | `promptx_action("lawyer")` | 代理原告{姓名} |
| 被告律师 | `promptx_action("lawyer")` | 代理被告{姓名} |
| 法官     | `promptx_action("judge")`  | 无需额外设定   |

### 切换流程

```
需要切换角色
↓
保存当前状态
↓
执行角色激活：promptx_action("target_role")
↓
绑定委托人身份（律师角色）
↓
加载目标角色状态
↓
验证切换成功
↓
开始发言
```

## 边界控制

### 律师边界

- **专一性**: 只代表一个委托人
- **忠诚性**: 必须维护委托人利益
- **独立性**: 不为其他方提供建议

### 法官边界

- **中立性**: 不偏向任何一方
- **程序控制**: 严格按庭审程序推进
- **裁判职能**: 基于事实与法律作出判决

## 角色冲突防护

1. **越界检测**：监控非授权访问和立场偏离
2. **立场一致性**：确保发言符合委托人利益
3. **自动纠正**：发现冲突立即中断并重新发言

## 异常处理

### 切换失败处理

```
检测到切换失败
↓
自动重试一次
↓
仍然失败时执行promptx_init刷新角色
↓
重新绑定身份并加载状态
```

- **角色激活失败**: 使用`promptx_init`刷新注册表
- **身份设定缺失**: 提示设定委托人身份
- **角色冲突**: 强制重新激活正确角色

---

**设计理念**：用最简单的标识和状态空间确保最可靠的角色独立性。
