# 智能模拟法庭 - 角色管理系统

## 设计理念

### 角色与实例分离

- **角色定义**：在 `.promptx` 中定义通用的专业角色（如 lawyer、judge）
- **角色实例**：在具体庭审中，同一角色可以有多个独立的实例
- **身份绑定**：每个角色实例通过动态身份设定绑定到具体的委托人或职责

## 核心角色

### 1. 律师角色 (lawyer)

- **角色 ID**: `lawyer`
- **实例化方式**: 动态委托人绑定
- **激活方式**: `promptx_action("lawyer")` + 委托人身份设定

#### 律师实例示例

```
原告律师实例：
- 角色：lawyer
- 委托人：原告李某
- 材料来源：案件/原告/ 文件夹
- 职责：维护原告利益

被告一律师实例：
- 角色：lawyer
- 委托人：被告何某
- 材料来源：案件/被告一/ 文件夹
- 职责：维护被告一利益

被告二律师实例：
- 角色：lawyer
- 委托人：被告施工方
- 材料来源：案件/被告二/ 文件夹
- 职责：维护被告二利益
```

### 2. 法官角色 (judge)

- **角色 ID**: `judge`
- **实例化方式**: 单一实例
- **激活方式**: `promptx_action("judge")`

## 动态身份设定机制

### 律师身份设定流程

1. **角色激活**: `promptx_action("lawyer")`
2. **身份声明**: 明确当前代理的委托人
3. **材料绑定**: 自动关联委托人文件夹中的材料
4. **立场确定**: 基于委托人利益确定发言立场
5. **状态持久化**: 系统记录当前激活的律师实例及其委托人身份

### 角色状态持久化机制

1. **状态记录**: 系统自动记录每个角色实例的当前状态
   - 律师角色: 记录当前代理的委托人、已读材料、立场观点
   - 法官角色: 记录案件进展、已确认的争议焦点
2. **切换验证**: 每次切换角色时验证状态完整性
3. **状态恢复**: 切换回角色时自动恢复上次记录的状态

### 身份设定模板

```
[当前角色：律师 - 代理{委托人名称}]
我是{委托人名称}的代理律师，基于委托人的{诉讼目标/答辩立场}，现就{具体问题}发表如下意见：
{具体论证内容}
```

## 角色切换规则

### 简化角色激活原则

1. **一次性初始化**：庭审开始时初始化所有角色
2. **轻量级切换**：发言时根据需要进行轻量级角色切换
3. **律师角色必须同时设定委托人身份**
4. **禁止跨角色发言或代为发言**
5. **角色激活失败时必须重新激活**

### 角色独立性保障机制

1. **身份隔离**：每个律师实例绑定唯一委托人 ID，确保角色不会混淆
2. **记忆隔离**：每个角色实例维护独立的记忆空间，包括:
   - 委托人身份记忆
   - 已读材料记忆
   - 立场观点记忆
   - 历史发言记忆
3. **切换验证**：每次切换时强制验证身份标识符匹配
4. **冲突检测**：系统自动检测并阻止跨角色信息泄露

### 角色激活清单

| 发言人     | 激活命令                   | 身份设定       |
| ---------- | -------------------------- | -------------- |
| 原告律师   | `promptx_action("lawyer")` | 代理原告{姓名} |
| 被告一律师 | `promptx_action("lawyer")` | 代理被告{姓名} |
| 被告二律师 | `promptx_action("lawyer")` | 代理被告{姓名} |
| 被告三律师 | `promptx_action("lawyer")` | 代理被告{姓名} |
| 法官       | `promptx_action("judge")`  | 无需额外设定   |

## 角色边界控制

### 律师职业操守

- **专一性**：每个律师实例只能代理一个委托人
- **忠诚性**：必须维护委托人的合法权益
- **独立性**：不得为其他当事人提供建议
- **保密性**：不得泄露委托人的内部材料

### 角色冲突防范

- **材料隔离**：律师只能访问自己委托人的材料
- **立场明确**：发言时必须明确代理身份
- **利益冲突检查**：禁止同时代理利益冲突的当事人

## 初始化与切换保障机制

### 庭审开始一次性初始化

1. **角色注册**：系统自动识别案件中的所有角色并注册
2. **实例创建**：为每个委托人创建独立的律师实例
3. **身份标识符分配**：每个律师实例分配唯一身份标识符（格式：role_clientID）
4. **状态空间初始化**：为每个角色实例创建独立状态空间
5. **验证测试**：对每个角色实例进行激活测试，确保可用

### 切换失败处理机制

1. **失败检测**：系统自动检测角色切换是否成功
2. **自动重试**：切换失败时自动重试一次
3. **恢复流程**：
   - 使用 `promptx_init` 重新刷新角色注册表
   - 重新执行角色激活命令并绑定身份
4. **人工干预**：三次失败后提示用户干预

## 实施要求

### 系统执行规则

1. **角色激活验证**：发言时检查角色激活状态
2. **身份设定检查**：律师角色必须完成委托人身份设定
3. **材料访问控制**：基于角色身份限制材料访问范围
4. **发言内容审核**：确保发言符合角色立场和职业操守

### 错误处理机制

- **角色不存在**：使用 `promptx_init` 刷新角色注册表
- **身份设定缺失**：提示完成委托人身份设定
- **角色冲突**：强制重新激活正确角色
- **材料访问越权**：限制访问并提示权限错误

## 优势分析

### 1. 架构简洁

- 只需维护少量通用角色定义
- 避免为每个当事人创建专门角色
- 角色管理成本低，扩展性强

### 2. 逻辑清晰

- 角色与实例分离，概念明确
- 动态身份绑定，灵活性高
- 职责边界清楚，避免混乱

### 3. 专业性强

- 符合真实法庭的律师执业模式
- 保证律师的专业操守和职业道德
- 确保庭审的公正性和对抗性

### 4. 可扩展性

- 新增当事人时无需创建新角色
- 支持复杂案件的多方当事人结构
- 便于系统功能的持续优化
