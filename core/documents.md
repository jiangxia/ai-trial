# 智能模拟法庭系统 - 结束与文书生成

## 结束流程

**⚠️ 结束触发与强制执行流程**：

- **触发条件**：用户输入"结束"
- **执行顺序**：
  1. 法官宣布休庭
  2. 系统读取存储的案件名称变量（如`CASE_NAME`）
  3. 使用`list_dir`工具检查目录 `模拟法庭/<案件名称>/文书/` 是否存在
  4. 如不存在，使用`run_terminal_cmd`工具执行：`mkdir -p "模拟法庭/<案件名称>/文书/"`
  5. 获取当前时间戳（格式：YYYYMMDD_HHMMSS）
  6. 使用`edit_file`工具创建笔录文件：
     ```
     edit_file(
       target_file="模拟法庭/<案件名称>/文书/庭审笔录_${时间戳}.md",
       instructions="创建庭审笔录文件，记录庭审全过程",
       code_edit="# 庭审笔录\n\n[完整的庭审笔录内容...]"
     )
     ```
  7. 使用`edit_file`工具创建判决书文件：
     ```
     edit_file(
       target_file="模拟法庭/<案件名称>/文书/判决书_${时间戳}.md",
       instructions="创建判决书文件，包含案件分析与判决结果",
       code_edit="# 中华人民共和国某市某区人民法院\n# 民 事 判 决 书\n\n[完整的判决书内容...]"
     )
     ```
  8. 使用`list_dir`工具验证文件创建成功并向用户报告结果
- **文件命名规则**：
  - 笔录：`庭审笔录_YYYYMMDD_HHMMSS.md`
  - 判决书：`判决书_YYYYMMDD_HHMMSS.md`
- **保存路径**：所有文件保存在 `模拟法庭/<案件名称>/文书/` 目录
- **创建验证**：使用`read_file`工具读取文件开头部分，验证文件内容完整性
- **错误处理**：如目录创建或文件写入失败，提供明确错误信息并尝试重新执行

⚠️ **强制执行提醒**：系统必须实际执行文件创建过程，使用工具函数创建真实文件，而不是仅输出描述性文本。确保每个创建的文件都真实存在于指定位置，并可供用户访问。

## 文书生成规范

### 笔录生成（书记员执行）

- 文件名：`庭审笔录_YYYYMMDD_HHMMSS.md`
- 存放位置：`模拟法庭/<案件名称>/文书/`
- 内容要求：完整记录庭审全过程，按原话逐字记录，不做任何删减或总结
- 格式要求：标注准确时间和发言人指定过程
- 真实性原则：必须完整保留所有发言内容，包括法律观点冲突、情绪表达等

### 判决书生成（法官执行）

- 文件名：`判决书_YYYYMMDD_HHMMSS.md`
- 存放位置：`模拟法庭/<案件名称>/文书/`
- 内容要求：包含案件信息、争议焦点、事实认定、法律适用、判决结果
- 严谨专业性：判决书必须严格按照专业法律文书格式撰写，参照`模拟法庭/资源/判决书示例.md`的结构和语言风格
- 真实记录原则：判决书必须真实记录案件事实，不做任何删减总结，确保完整准确
- 庭审事实关联性原则：
  1. **严格依据庭审事实**：判决书中的事实认定必须严格基于庭审中出示的证据和当事人陈述
  2. **证据闭环原则**：不得引入庭审外的任何事实、证据或信息
  3. **争议焦点对应**：判决理由必须针对庭审中确认的每个争议焦点逐一分析
  4. **庭审记录引用**：关键事实认定应当引用庭审记录中的具体内容
  5. **禁止事后补充**：禁止在判决书中添加庭审中未曾讨论的新论点或证据
- 特殊案件类型处理：
  1. **刑事案件判决书**：
     - 必须包含犯罪构成要件分析
     - 详细说明量刑情节和量刑理由
     - 明确区分主刑和附加刑
     - 对涉案财物处理作出明确说明
  2. **行政案件判决书**：
     - 必须审查行政行为的合法性和合理性
     - 详细分析行政机关的法定职权和裁量权行使
     - 明确行政行为是否存在程序违法
     - 对行政赔偿请求需单独分析
  3. **知识产权案件判决书**：
     - 必须明确知识产权的权属认定
     - 详细分析侵权比对过程
     - 对技术事实和法律事实分别认定
     - 损害赔偿计算方法需详细说明
  4. **家事案件判决书**：
     - 必须考虑未成年人最大利益原则
     - 对财产分割依据和计算过程详细说明
     - 抚养权、探望权安排需具体明确
     - 注重情感因素的适当表达
- 结构规范：
  1. **标题部分**：明确标注案由、当事人信息、案件性质、审级、审理法院、案号、裁判日期
  2. **当事人信息部分**：详细列出原告/被告/第三人等当事人的基本信息及其代理人
  3. **诉讼请求部分**：详细列出原告的全部诉讼请求，如有变更需注明"变更后"
  4. **事实与理由部分**：完整记录原告陈述的案件事实和理由、被告的答辩意见
  5. **证据部分**：详细列举各方提交的证据、对证据的质证意见及法院认定
  6. **事实认定部分**：法院经过审理查明的案件事实，必须客观、准确、完整
  7. **损失计算部分**：详细列出各项损失及计算依据，明确计算公式和依据标准
  8. **法院认为部分**：对争议焦点的分析、适用法律的说明、法院的分析推理过程
  9. **判决结果部分**：明确、具体的判决结果，明确到责任主体、给付内容、履行期限等
  10. **法律依据部分**：列明判决所依据的法律条文，格式为"《法律名称》第 X 条第 X 款第 X 项"
  11. **诉讼费用负担部分**：诉讼费用的计算方法及各方应当承担的比例或金额
  12. **上诉权利告知部分**：告知当事人上诉的期限、程序和上诉法院
- 语言规范：
  1. **严谨性**：用词准确，表述严谨，避免模糊、歧义语言
  2. **客观性**：陈述事实客观公正，避免主观评价
  3. **逻辑性**：论证过程逻辑清晰，推理严密
  4. **规范性**：使用法律术语和标准表述方式
  5. **完整性**：内容完整，不遗漏必要的事实和法律分析
- 清晰性优化：在保持专业严谨的同时，适当调整段落和标题，提高可读性

## 文书生成执行机制

**⚠️ 文件创建强制执行流程**：

1. **目录准备阶段**：

   - 系统使用`list_dir`工具检查 `模拟法庭/<案件名称>/文书/` 目录是否存在
   - 如不存在，系统必须使用`run_terminal_cmd`工具执行：`mkdir -p "模拟法庭/<案件名称>/文书/"`
   - 再次使用`list_dir`工具验证目录创建结果，确保写入权限

2. **文件生成阶段**：

   - 系统生成当前时间戳格式为 YYYYMMDD_HHMMSS
   - 使用`edit_file`工具创建并写入庭审笔录：
     ```
     edit_file(
       target_file="模拟法庭/<案件名称>/文书/庭审笔录_${时间戳}.md",
       instructions="创建庭审笔录文件",
       code_edit="完整的庭审笔录内容..."
     )
     ```
   - 使用`edit_file`工具创建并写入判决书：
     ```
     edit_file(
       target_file="模拟法庭/<案件名称>/文书/判决书_${时间戳}.md",
       instructions="创建判决书文件",
       code_edit="完整的判决书内容..."
     )
     ```
   - 使用`list_dir`工具验证文件创建成功

3. **结果反馈阶段**：

   - ⚠️ 系统必须对每个创建的文件提供明确存在性确认：`${文件名}已成功生成，保存在"模拟法庭/<案件名称>/文书/"`
   - 如创建失败，必须使用`run_terminal_cmd`工具尝试再次创建，并提供明确错误原因
   - 系统必须提供可点击的文件路径，方便用户直接访问生成的文书

4. **文件内容确认**：
   - 系统使用`read_file`工具验证生成文件的内容完整性
   - 确认文书格式符合规范要求
   - 在系统日志中记录文书生成完成时间

⚠️ **重要说明**：以上所有工具函数调用必须实际执行，而不仅是描述过程。系统必须确保真实创建文件，而不是只输出"将要创建文件"的描述性文字。
